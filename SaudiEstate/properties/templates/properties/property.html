{% extends 'base.html' %}
{% load static %}

{% block title %}{{ property.title }}{% endblock %}

{% block content %}
<div class="property-detail-container">

    <div class="prop-breadcrumb">
        <a href="{% url 'main:home' %}"><i class="fa-solid fa-house"></i></a>
        <span>›</span>
        <a href="#">{{ property.get_property_type_display }}</a>
        <span>›</span>
        <a href="#">{{ property.city }}</a>
        <span>›</span>
        <span class="current">{{ property.title }}</span>
    </div>

    <div class="prop-gallery">
        <div class="gallery-main" onclick="openModal(); currentSlide(1)" style="cursor: pointer;">
            {% if property.main_image %}
            <img src="{{ property.main_image.url }}" alt="{{ property.title }}">
            {% else %}
            <div class="placeholder-img">No Image</div>
            {% endif %}

            <div class="cam-badge">
                <i class="fa-solid fa-camera"></i> {{ property.images.count|add:"1" }}
            </div>
        </div>

        <div class="gallery-side">
            {% for img in property.images.all|slice:":2" %}
            <div class="side-item">
                <img src="{{ img.image.url }}" alt="Gallery">
            </div>
            {% empty %}
            <div class="side-item placeholder-img"></div>
            <div class="side-item placeholder-img"></div>
            {% endfor %}
        </div>
    </div>

    <div class="prop-header-bar">

        <div class="price-info">
            <h2>SAR {{ property.price }}</h2>
            <div class="prop-stats">
                <span><i class="fa-solid fa-bed"></i> {{ property.rooms }} Beds</span>
                <span><i class="fa-solid fa-bath"></i> {{ property.bathrooms }} Baths</span>
                <span><i class="fa-solid fa-ruler-combined"></i> {{ property.area }} sqm</span>
            </div>
        </div>

        <a href="{% url 'properties:toggle_favorite' property.pk %}" class="fav-btn">
            <span class="material-icons" id="fav-icon-{{ property.pk }}"
                onclick="toggleFavorite(event, {{ property.pk }})">
                {% if is_favorited %}
                favorite
                {% else %}
                favorite_border
                {% endif %}
            </span>
        </a>

        <div class="owner-card-display">
            <div class="owner-avatar">
                {% if property.owner.profile_image %}
                <img src="{{ property.owner.profile_image.url }}" alt="{{ property.owner.username }}">
                {% else %}
                <div class="default-avatar"><i class="fa-solid fa-user"></i></div>
                {% endif %}
            </div>

            <div class="owner-text">
                <span class="listed-by">Listed by</span>
                <h4 class="owner-name">
                    {{ property.owner.first_name }} {{ property.owner.last_name }}
                    {% if property.owner.is_property_owner %}
                    <i class="fa-solid fa-circle-check text-success" title="Verified"></i>
                    {% endif %}
                </h4>
                <div class="owner-phone">
                    <i class="fa-solid fa-phone"></i>
                    <span dir="ltr">{{property.owner.phone_number|default:"No number" }}</span>
                </div>
            </div>

            <a href="https://wa.me/{{ property.owner.phone_number }}" target="_blank" class="whatsapp-icon-btn">
                <i class="fa-brands fa-whatsapp"></i>
            </a>
        </div>

    </div>

    <div class="content-wrapper">
        <h3 class="section-heading">Property details</h3>

        <div class="details-grid">
            <div class="detail-item">
                <i class="fa-regular fa-building detail-icon"></i>
                <div class="detail-text">
                    <span class="label">Property Type</span>
                    <span class="value">{{ property.get_property_type_display }}</span>
                </div>
            </div>

            <div class="detail-item">
                <i class="fa-solid fa-bed detail-icon"></i>
                <div class="detail-text">
                    <span class="label">Bedrooms</span>
                    <span class="value">{{ property.rooms }}</span>
                </div>
            </div>

            <div class="detail-item">
                <i class="fa-solid fa-city detail-icon"></i>
                <div class="detail-text">
                    <span class="label">City</span>
                    <span class="value">{{ property.city }}</span>
                </div>
            </div>

            <div class="detail-item">
                <i class="fa-solid fa-map-pin detail-icon"></i>
                <div class="detail-text">
                    <span class="label">District</span>
                    <span class="value">{{ property.district }}</span>
                </div>
            </div>
            {% if property.location %}
            <div class="detail-item" style="grid-column: span 2;"> <i class="fa-solid fa-map-location-dot detail-icon"
                    style="color: #4285F4;"></i>
                <div class="detail-text w-100">
                    <span class="label">Location</span>
                    <a href="{{ property.location }}" target="_blank" class="map-link">
                        Open in Google Maps <i class="fa-solid fa-arrow-up-right-from-square ms-2"></i>
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="detail-item">
                <i class="fa-solid fa-maximize detail-icon"></i>
                <div class="detail-text">
                    <span class="label">Property Size</span>
                    <span class="value">{{ property.area }} sqm</span>
                </div>
            </div>

            <div class="detail-item">
                <i class="fa-solid fa-bath detail-icon"></i>
                <div class="detail-text">
                    <span class="label">Bathrooms</span>
                    <span class="value">{{ property.bathrooms }}</span>
                </div>
            </div>

            <div class="detail-item">
                <i class="fa-regular fa-calendar detail-icon"></i>
                <div class="detail-text">
                    <span class="label">Age</span>
                    <span class="value">{{ property.age }} Years</span>
                </div>
            </div>
        </div>

        <hr class="divider">

        <h3 class="section-heading">{{ property.title }}</h3>
        <div class="description-text">
            {{ property.description|linebreaks }}
        </div>

    </div>

</div>

<div id="myModal" class="modal">
    <span class="close cursor" onclick="closeModal()">&times;</span>
    <div class="modal-content">

        {% if property.main_image %}
        <div class="mySlides">
            <div class="numbertext">1 / {{ property.images.count|add:"1" }}</div>
            <img src="{{ property.main_image.url }}" style="width:100%">
        </div>
        {% endif %}

        {% for img in property.images.all %}
        <div class="mySlides">
            <div class="numbertext">{{ forloop.counter|add:"1" }} / {{ property.property.images.count|add:"1" }}</div>
            <img src="{{ img.image.url }}" style="width:100%">
        </div>
        {% endfor %}

        <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
        <a class="next" onclick="plusSlides(1)">&#10095;</a>
    </div>
</div>

<div class="inquiry-section">
    <h3 class="inquiry-title">Inquiries ({{ inquiries.count }})</h3>

    <div class="inquiry-list">
        {% for inquiry in inquiries %}
        <div class="inquiry-item">
            <div class="inquiry-header">
                <span class="from">{{ inquiry.sender.username }}:</span>
                <span class="date">{{ inquiry.created_at|date:"M d, Y - h:i a" }}</span>
            </div>

            <p class="msg">{{ inquiry.message }}</p>
            {% if request.user == inquiry.sender or request.user == property.owner %}
            <form action="{% url 'inquiries:delete_inquiry' inquiry.id %}" method="POST" class="d-inline">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Are you sure you want to delete this comment?');">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </form>
            {% endif %}


            {% for reply in inquiry.replies.all %}
            <div class="reply-item">
                <div class="reply-header">
                    <span class="reply-from">Owner:</span>
                    <span class="reply-date">{{ reply.created_at|date:"M d, Y - h:i a" }}</span>
                </div>
                <p class="reply-text">{{ reply.message }}</p>
                {% if request.user == reply.sender %}
                <form action="{% url 'inquiries:delete_reply' reply.id %}" method="POST" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this reply?');">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}


            {% if request.user.is_authenticated and request.user.id == property.owner.id %}
            <form method="POST" action="{% url 'inquiries:reply' inquiry.id %}" class="reply-form">
                {% csrf_token %}
                <input type="text" name="reply" placeholder="Write a reply..." required>
                <button>Reply</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button id="show-more-inquiries-btn" class="btn btn-primary"
            style="display: none; border-radius: 50px; padding: 8px 25px; cursor: pointer;">
            Show all inquiries <i class="fa-solid fa-chevron-down ml-2"></i>
        </button>
    </div>
</div>


{% if related_properties %}
<div class="related-section">
    <h3 class="section-heading">You might also like</h3>
    <div class="properties-grid">
        {% for prop in related_properties %}
        {% include 'properties/card.html' with property=prop %}
        {% endfor %}
    </div>
</div>

<div class="inquiry-box">
    <form method="POST" action="{% url 'inquiries:send' property.id %}">
        {% csrf_token %}
        <textarea name="message" placeholder="Write your message..." required></textarea>
        <button type="submit">Send Inquiry</button>
    </form>
</div>
{% endif %}


<script>
    function openModal() {
        document.getElementById("myModal").style.display = "block";
        document.body.style.overflow = "hidden";
    }

    function closeModal() {
        document.getElementById("myModal").style.display = "none";
        document.body.style.overflow = "auto";
    }

    var slideIndex = 1;
    showSlides(slideIndex);

    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    function showSlides(n) {
        var i;
        var slides = document.getElementsByClassName("mySlides");
        if (n > slides.length) { slideIndex = 1 }
        if (n < 1) { slideIndex = slides.length }
        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        slides[slideIndex - 1].style.display = "block";
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });
</script>

<script>
    function toggleFavorite(event, propertyId) {
        event.preventDefault();
        const favIcon = document.getElementById(`fav-icon-${propertyId}`);

        fetch(`/properties/favorite/${propertyId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    favIcon.innerHTML = 'favorite';
                    favIcon.style.color = "red";
                } else if (data.status === 'removed') {
                    favIcon.innerHTML = 'favorite_border';
                    favIcon.style.color = "";
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const items = document.querySelectorAll(".inquiry-item");
        const btn = document.getElementById("show-more-inquiries-btn");
        const limit = 3;

        if (items.length > limit) {
            btn.style.display = "inline-block";

            for (let i = limit; i < items.length; i++) {
                items[i].style.display = "none";
            }
        }

        btn.addEventListener("click", function () {
            const isExpanded = btn.getAttribute("data-expanded") === "true";

            if (isExpanded) {
                for (let i = limit; i < items.length; i++) {
                    items[i].style.display = "none";
                }
                btn.innerHTML = 'Show all inquiries <i class="fa-solid fa-chevron-down ml-2"></i>';
                btn.setAttribute("data-expanded", "false");
            } else {
                items.forEach(item => {
                    item.style.display = "block";
                });
                btn.innerHTML = 'Show less <i class="fa-solid fa-chevron-up ml-2"></i>';
                btn.setAttribute("data-expanded", "true");
            }
        });
    });
</script>

{% endblock %}